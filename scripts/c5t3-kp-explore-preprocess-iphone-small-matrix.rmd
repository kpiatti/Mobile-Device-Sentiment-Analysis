---
title: "Preprocess & Explore iPhone Small Matrix"
author: "Katherine Piatti"
date: "4/29/2021"
output: 
 html_document:
 theme: united
 toc: TRUE
 toc_depth: 2
 toc_float: TRUE
 highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# SETUP ##########################################

## Project Overview ##############################

The goal of this project is to develop a model that represents how people feel (sentiment) about particular mobile devices based on what they say about those devices online. 


## Current Goals ####################################

In this script I'll be wrangling and exploring just the data concerning iphones.


## Libraries & Renv #####################################

  - I ran renv::init 2021-39-04 2:08PM
  
```{r}
#load pkgs
library(tidyverse)
library(here)
library(janitor)
library(corrr)
library(GGally)

library(caret)
library(doParallel)
```


## Import Data ###################################

```{r}
#read in iphone small matrix
iphone_df_orig <- read.csv(here("data", "iphone_smallmatrix_labeled_8d.csv")) 

# define copy of original data and clean names & remove empties
iphone_df <- iphone_df_orig %>%
  clean_names() %>% 
  remove_empty()
```


## Parallel Processing ###########################
```{r}
#get numberr of cores on my machine
detectCores()

# create cluster
ppcluster <- makeCluster(3)

#register cluster
registerDoParallel(ppcluster)

# get number of cores now assigned to R
getDoParWorkers()
```
When done working in R for the day, don't forget to stopCluster(ppcluster)


# PRE-PROCESSING ################################

```{r}
#get overview of data
glimpse(iphone_df)
```

## Remove Unrelated Variables ######################

I see this dataset includes variables concerning mobile devices other than the iphone (e.g. nokia, samsung). So my first order of business is to remove any variables unrelated to iphones. 

I know from examining the Helio sentiment analysis matrix detail spreadshet that **all** and **only** the variables concerning the iphone start with either "iphone" or "ios". So I will select only those columns. 

```{r}
#select only columns that start with iphone or ios
iphone_df <- iphone_df %>% 
  select(starts_with(c("iphone", "ios"))) 

glimpse(iphone_df)
```

Now we have a tibble with 14 feature variables and 1 target (iphonesentiment) 


## Missing Values #################################

```{r}
#check for missing values
iphone_df %>% 
  is.na() %>% 
  sum()
```
There are no explicit NAs in the data. But it's also important to check for other values that might be representing missing values (e.g 999).

```{r}
iphone_df %>% 
  map(unique)
```
None of the values in any of the columns look like substitues for NA.


## Duplicates ###################################

Technically, given that the website for each observation has been stripped and there's no other variable or set of variables that can be used to uniquely identify observations, there's no way to know for sure whether any of the observations in df are duplicates--it's possible observations with the same values for all variables are different websites which just happen to mention the iphone, camera, etc. the exact same number of times as another website. I don't know what the chances are of that happening across 15 variables, but it's probably very low. 

And we know that reviews from one website are often re-published on other websites, so I'm going to to assume that observations with the same values for every variable are, in fact, duplicates that should be removed. 

```{r}
iphone_df %>% 
  duplicated() %>% 
  sum()
```


# EXPLORATION ##########################################

## Histograms ################

```{r}
iphone_df %>% 
  map(hist)
```

All of the independent variables have very skewed distributions swamped by zeros. Let's look at variance.


## Feature Correlations #################################

```{r}
#get var correlations > 0.7 abd -0.7
(corr <- iphone_df %>% 
  correlate() %>% 
  shave() %>% 
  stretch() %>% 
  filter(abs(r) > 0.7) %>% 
  arrange(desc(r)))
```

It's surprising that variables representing positive and negative sentiment towards a particular iphone feature (e.g. display) are among those with the highest positive correlations. The variables in question record the number of positive or negative (respectively) words or expressions near the feature word (e.g. "display") or it's synonyms.

Thus, the high positive correlation between these variables suggests as the number of positive words about the feature increases so too does the number of negative words about the feature. 

It's also notable that none of the highest correlations are with our target variable--iphonesentiment.

```{r}
iphone_df %>% 
  select(c(iphonedispos, iphonedisneg, iphonedisunc, iphonesentiment)) %>% 
  ggpairs()
```

```{r}
iphone_df %>% 
  select(iphoneperpos, iphoneperneg, iphoneperunc, iphonesentiment) %>% 
  ggpairs()
```



## Feature Variance ######################################

```{r}
#look for vars with near zero variance
iphone_df %>% 
  nearZeroVar(saveMetrics = TRUE) %>% 
  arrange(nzv)
```

Since there's near zero variance in all the variables representing sentiment toward the iphone OS, those 4 variables are good candidates for removal. 


## Recursive Feature Selection ##################################

```{r}
set.seed(123)

#define 3,000 obs. sample
iphone_sample <-  slice_sample(.data = iphone_df,
             n = 3000, 
             replace = FALSE)


#move target variable to end
iphone_sample <- iphone_sample %>% 
  relocate(iphonesentiment,
           .after = iosperunc)

#set up rfe control with randomn forest and repeated CV
ctrl <- rfeControl(functions = rfFuncs,
                   method = "repeatedcv",
                   repeats = 5, 
                   verbose = FALSE)
```


```{r}
set.seed(999)

rfe_results <- rfe(iphone_sample[, 1:14], 
                   iphone_sample$iphonesentiment, 
                   rfeControl = ctrl)

#get results
rfe_results
```

The model with all 14 variable was selected as performing best on the sample data. 


```{r}
plot(rfe_results)
```

#  DV Data Type ################################################

The dependent variable (iphonesentiment) is set as data type: integer because it contains values 1-5. However, those values correspond to different overall sentiment toward the iphone.
    
    * 0 = sentiment unclear
    * 1 = negative
    * 2 = somewhat negative
    * 3 = neutral
    * 4 = somewhat positive
    * 5 = positive

Given this, the data type of iphonesentiment should be changed to factor.

```{r}
iphone_df$iphonesentiment <-  as_factor(iphone_df$iphonesentiment)

class(iphone_df$iphonesentiment)
```

```{r}
iphone_df$iphonesentiment <- fct_recode(iphone_df$iphonesentiment,
             unclear = "0",
             neg = '1',
             vneg = '2',
             neutral = '3',
             pos = '4',
             vpos = '5')

head(iphone_df$iphonesentiment)
```








